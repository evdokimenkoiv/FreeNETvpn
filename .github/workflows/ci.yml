name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  lint_bash:
    name: Shellcheck (bash)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install shellcheck
        run: sudo apt-get update -y && sudo apt-get install -y shellcheck
      - name: Run shellcheck
        run: |
          shopt -s globstar
          shellcheck -x install.sh menu.sh restore.sh scripts/**/*.sh || true

  lint_yaml:
    name: Lint YAML (yamllint via pip)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install yamllint
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install yamllint
      - name: Run yamllint (relaxed)
        run: |
          set -e
          if [ -f .yamllint ]; then
            yamllint -c .yamllint docker-compose.yml .github/workflows || true
          else
            yamllint docker-compose.yml .github/workflows || true
          fi
          echo "YAML lint finished (warnings ignored)."

  validate_env:
    name: Validate .env.example variables
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run validator
        run: python3 tools/validate_env.py

  build_admin:
    name: Build admin image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: docker build -t freenetvpn-admin ./admin

  compose_check:
    name: docker-compose config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install docker-compose
        run: sudo apt-get update -y && sudo apt-get install -y docker-compose
      - name: Validate compose
        run: docker-compose config

  bundle_release:
    name: Bundle repo artifact
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create bundle via git archive
        id: bundle
        run: |
          ts=$(date +%s)
          FILENAME="FreeNETvpn-bundle-${ts}.tar.gz"
          git archive --format=tar.gz -o "$FILENAME" HEAD
          echo "file=$FILENAME" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FreeNETvpn-bundle
          path: ${{ steps.bundle.outputs.file }}
          if-no-files-found: error
          retention-days: 7
